<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Điểm tướng SSR & Exp</title>
<style>
:root{--bg:#ffffff;--card:#f8f8f8;--muted:#555555;--accent:#60a5fa;--fire:#e11d48;--water:#0284c7;--wind:#10b981;--light:#facc15;--dark:#6366f1;--earth:#a16207;--exp:#6b7280;}
body{margin:0;padding:18px;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#012;}
.app{max-width:1100px;margin:0 auto;}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px;}
.tabs{display:flex;gap:6px;flex-wrap:wrap;}
.tab{padding:8px 12px;border-radius:10px;cursor:pointer;background:#eaeaea;color:var(--muted);border:1px solid rgba(0,0,0,0.06)}
.tab.active{font-weight:600;}
.grid{display:grid;grid-template-columns:1fr 360px;gap:16px;}
.panel{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.06);}
.hero-list{display:flex;flex-direction:column;gap:10px;max-height:520px;overflow:auto;}
.hero{display:grid;grid-template-columns:1fr 100px 100px 120px 80px;gap:8px;align-items:center;padding:8px;border-radius:8px;background:#fff;border:1px solid rgba(0,0,0,0.04);}
.hero small{color:var(--muted);}
.hero.fire { border-left:6px solid var(--fire); background:#fff; }
.hero.cung { border-left:6px solid var(--light); background:#fff; }
.hero.độc { border-left:6px solid var(--wind); background:#fff; }
.hero.băng { border-left:6px solid var(--water); background:#fff; }
.hero.exp { border-left:6px solid var(--exp); background:#fff; }  
input[type="number"], select, input[type="text"]{width:100%;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:inherit}
.btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer;background:var(--accent);color:#fff;font-weight:600;}
.btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.08);color:var(--muted);}
.summary{display:flex;flex-direction:column;gap:8px;margin-top:10px;}
.row{display:flex;justify-content:space-between;align-items:center;}
.big{font-size:18px;font-weight:700;}
footer{margin-top:16px;color:var(--muted);font-size:13px;text-align:center;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);backdrop-filter:blur(4px);justify-content:center;align-items:center;z-index:9999;animation:fadeIn .2s ease;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.modal-content{background:white;width:95%;max-width:440px;border-radius:18px;padding:0;font-family:Segoe UI, sans-serif;border:4px solid var(--m-color);animation:popin .25s ease;}
@keyframes popin{from{transform:scale(.9);opacity:0;}to{transform:scale(1);opacity:1;}}
.modal-header{padding:14px 18px;font-size:20px;font-weight:700;color:white;border-radius:14px 14px 0 0;}
.modal-body{padding:18px;font-size:16px;line-height:1.5;white-space:pre-line;}
.modal-footer{padding:16px;}
.modal-footer button{width:100%;padding:12px;background:var(--m-color);color:white;border:none;border-radius:10px;font-size:16px;cursor:pointer;}
.sys-Lửa{--m-color:var(--fire);} .sys-Cung{--m-color:var(--light);} .sys-Độc{--m-color:var(--wind);} .sys-Băng{--m-color:var(--water);} .sys-Exp{--m-color:var(--exp);}
</style>
</head>
<body>
<div class="app">
  <header>
    <div><h1>Điểm tướng SSR & Exp</h1><div style="color:var(--muted);font-size:13px;margin-top:6px">Chỉ hiện kết quả khi bấm "Tính". 1 thẻ SSR = 14.000 điểm. EXP: B+ 100 / B 700 / SR 3.500.</div></div>
    <div class="controls"><div class="tabs" id="tabs"></div></div>
  </header>
  <main class="grid">
    <section class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div><strong id="systemTitle">Lửa</strong></div>
        <div class="flex"><button class="btn" id="btnCalcAll">Tính toàn bộ</button></div>
      </div>
      <div style="margin-bottom:12px;display:flex;gap:10px"><input id="filterHero" placeholder="Tìm tướng theo tên" /></div>
      <div class="hero-list" id="heroList"></div>
    </section>
    <aside class="panel">
      <div><strong>Tổng kết</strong></div>
      <div class="summary" id="summary"></div>
    </aside>
  </main>
  <footer>Dữ liệu tự lưu trên trình duyệt.</footer>
</div>
<div id="resultModal" class="modal"><div id="modalBox" class="modal-content"><div id="modalHeader" class="modal-header">Kết quả</div><div id="modalBody" class="modal-body"></div><div class="modal-footer"><button onclick="closeModal()">Đóng</button></div></div></div>

<script>
/* full hero logic (same as original) */
const COST_ARRAY = {0:[20,20],1:[30,40,50],2:[60,70,80,80],3:[100,110,120,130,140],4:[170,180,190,200,210],5:[]};
const CARD_POINT = 14000;
const SYSTEMS = ["Lửa","Cung","Độc","Băng"];
const EXP_CATS = {"B+":100,"B":700,"SR":3500};
const heroesData = {
  "Lửa": ["Dolvar","Paul","Alex","Allen","Anko","Apollo","Blaise","Brie","Catrina","Christie","Cosette","Dain","Darcy","Daria","Dean","Edmund","Erika","Fiona","Gisele","Gro","Ivy","Kenshiro","Kirona","Kyle","Lovelace","Mirai","Penny","Seraphin","Simon","Sindra","Theodore","Tracy","Vanessa","Wallis"],
  "Cung": ["Aidan","Alden","Ariza","Authur","Bella","Colin","Doris","Dylan","Eleanora","Fatima","Gabriel","Green","Jennifer","Johannes","Kadir","Kailin","Layla","Livia","Maya","Meg","Mira","Montag","O'Neil","Padme","Pan","Ptolemy","Richard","Ryan","Sahar","Sebastian","Seraphia","Solder","Torvi","Trist"],
  "Độc": ["Allison","Angelina","Arwin","Benjamin","Blackwell","Boudica","Catherine","Chiyoko","Claudia","Daisy","Elia","Gruen","Issac","Lilith","Lomax","Luvia","Maxwell","Meniere","Morgana","Mycelia","Naga","Pythia","Rila","Rogers","Rosamond","Suad","Tumnus","Viper","Viola","Webster","Wendy"],
  "Băng": ["Aurora","Christine","Clarence","Enzo","Eslaine","Filius","Hadi","Hana","Hathes","Havik","Jessica","Judy","Keith","Lilani","Loka","Maud","Nathaniel","Nicole","Nina","Nivea","Olaf","Parr","Paula","Pedra","Ralph","Rebecca","Rudolph","Selene","Trishy","Vera","Ao Deng","Ao Yue"]
};
const expList = { "B+": ["Daniel"], "B": ["Anton","Peter","Etley"], "SR": ["Alucard","Samar","Harold","Kris","Merlin","Ophelia","Arwyn"]};
const LS_KEY_PREFIX = "acc_";
const $ = id=>document.getElementById(id);
let state={heroes:[],activeTab:SYSTEMS[0]};
function idNow(){return "h-"+Math.random().toString(36).slice(2,9);}
function formatNumber(n){return Number(n).toLocaleString("vi-VN");}
function maxBarForStar(st){return (COST_ARRAY[st]||[]).length;}
function costFor(st,bar){return (COST_ARRAY[st]||[])[bar]||null;}
function defaultHeroData(name,system){let sys=system; for(const cat in expList) if(expList[cat].includes(name)) sys="Exp"; return {id:idNow(),name,system:sys,current_star:0,current_bar:0,cards_owned:0};}
function calculateUpgrade(hero){
  if(hero.system==="Exp"){
    let rank=null; for(const cat in expList) if(expList[cat].includes(hero.name)) rank=cat;
    let per = rank? EXP_CATS[rank]:0;
    let cards = Number(hero.cards_owned)||0;
    return {isExp:true,exp_rank:rank,exp_per_card:per,exp_points:cards*per,cards_consumed:cards,cards_left:0,final_star:0,final_bar:0,missing_to_5:0};
  }
  let star=hero.current_star||0, bar=hero.current_bar||0, cards=hero.cards_owned||0, consumed=0;
  while(cards>0){
    if(star>=5) break;
    const maxBar=maxBarForStar(star);
    if(bar>=maxBar){ star++; bar=0; continue; }
    const needed=costFor(star,bar);
    if(needed===null) break;
    if(cards>=needed){ cards-=needed; consumed+=needed; bar++; } else break;
  }
  const cards_left=cards;
  let ms=0,s=star,b=bar;
  while(s<5){
    const maxBar=maxBarForStar(s);
    if(b>=maxBar){ s++; b=0; continue;}
    const need=costFor(s,b);
    if(need===null){ ms=Infinity; break; }
    ms+=need; b++;
  }
  return {isExp:false,final_star:star,final_bar:bar,cards_consumed:consumed,cards_left:cards_left,missing_to_5:ms};
}
function showModal(title,msg,system){ const modal=$("resultModal"), header=$("modalHeader"), body=$("modalBody"), box=$("modalBox"); box.className="modal-content sys-"+system; header.innerText=title; body.innerText=msg; modal.style.display="flex"; }
function closeModal(){ $("resultModal").style.display="none"; }

function createHeroElement(h){
  const box=document.createElement("div"); box.className="hero";
  let cls=h.system==="Lửa"?"fire":h.system==="Cung"?"cung":h.system==="Độc"?"độc":h.system==="Băng"?"băng":"exp"; box.classList.add(cls);
  const nameCol=document.createElement("div"); nameCol.innerHTML=`<div style="font-weight:600">${h.name}</div><small>${h.system}</small>`;
  const starCol=document.createElement("div"); const starSel=document.createElement("select"); starSel.innerHTML=Array.from({length:6}).map((_,i)=>`<option value="${i}" ${i===h.current_star?'selected':''}>${i}★</option>`).join("");
  starSel.onchange=()=>{ h.current_star=parseInt(starSel.value,10); if(h.current_bar>maxBarForStar(h.current_star)) h.current_bar=maxBarForStar(h.current_star); saveState(); renderSummary(); };
  starCol.appendChild(starSel);
  const barCol=document.createElement("div"); const barSel=document.createElement("select"); const maxBar=maxBarForStar(h.current_star); barSel.innerHTML=Array.from({length:maxBar+1}).map((_,i)=>`<option value="${i}" ${i===h.current_bar?'selected':''}>Bậc ${i}</option>`).join("");
  barSel.onchange=()=>{ h.current_bar=parseInt(barSel.value,10); saveState(); renderSummary(); }; barCol.appendChild(barSel);
  const cardCol=document.createElement("div"); const cardsInput=document.createElement("input"); cardsInput.type="number"; cardsInput.min=0; cardsInput.value=h.cards_owned||0; cardsInput.onchange=()=>{ h.cards_owned=Math.max(0,Math.floor(Number(cardsInput.value)||0)); saveState(); };
  cardCol.appendChild(cardsInput);
  const opsCol=document.createElement("div"); opsCol.className="hero-ops"; const calcBtn=document.createElement("button"); calcBtn.className="btn ghost"; calcBtn.textContent="Tính"; calcBtn.onclick=()=>showModalResult(h); opsCol.appendChild(calcBtn);
  box.appendChild(nameCol); box.appendChild(starCol); box.appendChild(barCol); box.appendChild(cardCol); box.appendChild(opsCol);
  return box;
}

function renderHeroList(){
  const list=$("heroList"); list.innerHTML=""; const f=($("filterHero").value||"").trim().toLowerCase();
  if(SYSTEMS.includes(state.activeTab)){ (heroesData[state.activeTab]||[]).forEach(n=>{ if(f && !n.toLowerCase().includes(f)) return; const h=state.heroes.find(x=>x.name===n); if(h) list.appendChild(createHeroElement(h)); }); } else { for(const cat in expList) if(cat===state.activeTab) expList[cat].forEach(n=>{ if(f && !n.toLowerCase().includes(f)) return; const h=state.heroes.find(x=>x.name===n); if(h) list.appendChild(createHeroElement(h)); }); }
}

function renderSummary(){
  const box=$("summary"); box.innerHTML=""; const totals={}; SYSTEMS.concat(Object.keys(expList)).forEach(s=>totals[s]=0);
  state.heroes.forEach(h=>{ let pts=0; if(h.system==="Exp"){ for(const cat in expList) if(expList[cat].includes(h.name)){ pts=(h.cards_owned||0)*EXP_CATS[cat]; totals[cat]+=pts; break;} } else { const r=calculateUpgrade(h); let pCount=r.cards_consumed; if(r.final_star>=5) pCount+=r.cards_left; pts=pCount*CARD_POINT; totals[h.system]+=pts; } });
  let grandTotal=0;
  for(const s in totals){ const r=document.createElement("div"); r.className="row"; r.innerHTML=`<span>${s}</span><span class="big">${formatNumber(totals[s])}</span>`; box.appendChild(r); grandTotal+=totals[s]; }
  const totalRow=document.createElement("div"); totalRow.className="row"; totalRow.style.borderTop="1px solid #ccc"; totalRow.style.fontWeight="700"; totalRow.innerHTML=`<span>Tổng điểm</span><span class="big">${formatNumber(grandTotal)}</span>`; box.appendChild(totalRow);
  try{ parent.postMessage({type:'updatePoint', tab:'tuong', value: grandTotal}, "*"); } catch(e){}
}
  // Dòng tổng điểm
  const totalRow = document.createElement("div");
  totalRow.className = "row";
  totalRow.style.borderTop = "1px solid #ccc";
  totalRow.style.fontWeight = "700";
  totalRow.innerHTML = `<span>Tổng điểm</span><span class="big">${formatNumber(grandTotal)}</span>`;
  box.appendChild(totalRow);
}

function renderTabs(){
  const tabs=$("tabs"); tabs.innerHTML="";
  SYSTEMS.concat(Object.keys(expList)).forEach(s=>{
    const t=document.createElement("div"); t.className="tab"+(state.activeTab===s?" active":""); t.textContent=s;
    const color=s==="Lửa"?"var(--fire)":s==="Cung"?"var(--light)":s==="Độc"?"var(--wind)":s==="Băng"?"var(--water)":"var(--exp)";
    if(state.activeTab===s){ t.style.background=color; t.style.color="#fff"; t.style.fontWeight="600"; } else { t.style.background="#eaeaea"; t.style.color="var(--muted)"; t.style.fontWeight="400"; }
    t.onclick=()=>{ state.activeTab=s; saveState(); renderTabs(); renderHeroList(); $("systemTitle").innerText=s; };
    tabs.appendChild(t);
  });
}

function saveState(){ localStorage.setItem(LS_KEY,JSON.stringify(state)); }
function loadState(){
  const data=localStorage.getItem(LS_KEY);
  if(data){ state=JSON.parse(data);} 
  SYSTEMS.concat(Object.keys(expList)).forEach(s=>{ (heroesData[s]||[]).forEach(n=>{ if(!state.heroes.find(h=>h.name===n)) state.heroes.push(defaultHeroData(n,s)); }); });
  for(const cat in expList) expList[cat].forEach(n=>{ if(!state.heroes.find(h=>h.name===n)) state.heroes.push(defaultHeroData(n,"Exp")); });
  saveState();
}

$("filterHero").oninput=renderHeroList;
$("btnCalcAll").onclick=()=>{renderSummary();};

loadState(); renderTabs(); renderHeroList(); renderSummary();
/* account save/load */
let currentAcc = localStorage.getItem("current_acc") || "";
function heroKey(acc){ return "acc_" + acc + "_hero"; }
function saveState(){ try{ localStorage.setItem(heroKey(currentAcc), JSON.stringify(state)); // also save points
    const totals = {}; SYSTEMS.concat(Object.keys(expList)).forEach(s=>totals[s]=0); state.heroes.forEach(h=>{ let pts=0; if(h.system==="Exp"){ for(const cat in expList) if(expList[cat].includes(h.name)){ pts=(h.cards_owned||0)*EXP_CATS[cat]; totals[cat]+=pts; break;} } else { const r=calculateUpgrade(h); let pCount=r.cards_consumed; if(r.final_star>=5) pCount+=r.cards_left; pts=pCount*CARD_POINT; totals[h.system]+=pts; } }); const grand = totals; const store = JSON.parse(localStorage.getItem("acc_" + currentAcc + "_points") || "{}"); store.tuong = grandTotalFromTotals(grand); localStorage.setItem("acc_" + currentAcc + "_points", JSON.stringify(store));
 } catch(e){} }
function grandTotalFromTotals(totals){ let s=0; for(const k in totals) s+=totals[k]; return s; }
function loadState(){
  const raw = localStorage.getItem(heroKey(currentAcc));
  if(raw){ try{ state = JSON.parse(raw); return; } catch(e){} }
  state={heroes:[],activeTab:SYSTEMS[0]};
  SYSTEMS.concat(Object.keys(expList)).forEach(s=>{ (heroesData[s]||[]).forEach(n=>{ if(!state.heroes.find(h=>h.name===n)) state.heroes.push(defaultHeroData(n,s)); }); });
  for(const cat in expList) expList[cat].forEach(n=>{ if(!state.heroes.find(h=>h.name===n)) state.heroes.push(defaultHeroData(n,"Exp")); });
  saveState();
}

/* messaging */
window.addEventListener("message", e=>{
  const d = e.data || {};
  if(d && d.type === "acc_changed"){ currentAcc = d.acc || localStorage.getItem("current_acc") || ""; loadState(); renderTabs(); renderHeroList(); renderSummary(); }
  if(d && d.type === "request_point"){ const raw = localStorage.getItem("acc_" + currentAcc + "_points") || "{}"; const pts = JSON.parse(raw).tuong || 0; try{ parent.postMessage({type:'updatePoint', tab:'tuong', value: pts}, "*"); } catch(e){} }
});
window.parent.postMessage({type:'ready'}, "*");
loadState(); renderTabs(); renderHeroList(); renderSummary();
</script>
</body>
</html>
