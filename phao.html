<!DOCTYPE html>
<html lang="vi">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Level pháo</title>
<style>
body{font-family:sans-serif;background:#eef2f5;padding:20px}
.container{max-width:800px;margin:auto;background:white;padding:20px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.1)}
.input-group{margin-bottom:12px}
input{width:100%;padding:12px;border-radius:10px;border:1px solid #aaa;font-size:16px}
button{width:100%;min-height:50px;padding:12px;background:#2563eb;color:white;font-size:18px;border-radius:12px;border:none;cursor:pointer;margin-bottom:8px}
.result{margin-top:20px;padding:14px;background:#f8fafc;border-radius:12px;border:1px solid #ccc;word-break:break-word}
pre.log{white-space:pre-wrap;font-family:monospace}
h2{margin-bottom:16px}
.small{font-size:13px;color:#666;margin-top:8px}
</style>
</head>
<body>
<div class="container">
<h2>Level pháo</h2>
<div class="input-group"><label>Đá</label><input type="number" id="stone" value="0" min="0"></div>
<div class="input-group"><label>Gỗ</label><input type="number" id="wood" value="0" min="0"></div>
<div class="input-group"><label>Quặng</label><input type="number" id="ore" value="0" min="0"></div>
<div class="input-group"><label>Hộp pháo</label><input type="number" id="boxes" value="0" min="0"></div>
<div class="input-group"><label>Cấp mục tiêu</label><input type="number" id="targetLevel" value="" min="1" placeholder="Để trống nếu muốn tính cấp tối đa"></div>
<button id="btnCompute">Tính</button>
<div id="output" class="result" style="visibility:hidden"></div>
<div class="small">Tài khoản hiện tại: <span id="curAcc">-</span></div>
</div>

<script>
let currentAcc = localStorage.getItem("current_acc") || "";
const keyFor = acc => "acc_" + acc + "_phao";

function toNum(id){ let v = Number(document.getElementById(id).value); return (isNaN(v)||v<0)?0:v; }

function simulateOptimal(S,W,Q,B,lv){
    let stone=S, wood=W, ore=Q, box=B, log=[];
    const needStone = 1260*lv;
    const needWood = 340*lv;
    const needOre = 130*lv;
    let boxForOre = Math.min(box, needOre - ore);
    if(boxForOre>0){ log.push(`Dùng ${boxForOre} hộp → +${boxForOre} quặng`); ore += boxForOre; box -= boxForOre; }
    let boxForWood = Math.min(box, Math.ceil((needWood - wood)/4));
    if(boxForWood>0){ log.push(`Dùng ${boxForWood} hộp → +${boxForWood*4} gỗ`); wood += boxForWood*4; box -= boxForWood; }
    if(box>0){ log.push(`Dùng ${box} hộp → +${box*20} đá`); stone += box; box=0; }
    while(true){
        let missOre = Math.max(0, needOre - ore);
        let missWood = Math.max(0, needWood - wood);
        let stoneToWood = Math.min(Math.floor(stone/5), missWood + missOre*4);
        if(stoneToWood>0){ log.push(`Đổi ${stoneToWood*5} đá → +${stoneToWood} gỗ`); stone -= stoneToWood*5; wood += stoneToWood; }
        let woodToOre = Math.min(Math.floor(wood/4), missOre);
        if(woodToOre>0){ log.push(`Đổi ${woodToOre*4} gỗ → +${woodToOre} quặng`); wood -= woodToOre*4; ore += woodToOre; }
        if(stoneToWood===0 && woodToOre===0) break;
    }
    let missStone = Math.max(0, needStone - stone);
    let missWood = Math.max(0, needWood - wood);
    let missOre = Math.max(0, needOre - ore);
    if(missStone>0 || missWood>0 || missOre>0){
        return {ok:false, missing:{stone:missStone, wood:missWood, ore:missOre}, log:log};
    }
    stone -= needStone; wood -= needWood; ore -= needOre;
    return {ok:true, log, remaining:{stone, wood, ore}};
}

function computeMaxLv(S,W,Q,B){
    let lo=0, hi=20000, lastLog=[], lastRemaining=null;
    while(lo<hi){
        let mid = Math.floor((lo+hi+1)/2);
        let result = simulateOptimal(S,W,Q,B,mid);
        if(result.ok){ lo = mid; lastLog = result.log; lastRemaining = result.remaining; } else { hi = mid-1; }
    }
    return {maxLv: lo, log: lastLog, remaining: lastRemaining};
}

function compute(){
    let S=toNum('stone'), W=toNum('wood'), Q=toNum('ore'), B=toNum('boxes');
    let targetInput = document.getElementById('targetLevel').value.trim();
    const out = document.getElementById('output'); out.style.visibility='visible';
    if(targetInput !== ""){
        let target = Math.max(1, Number(targetInput));
        let result = simulateOptimal(S,W,Q,B,target);
        if(result.ok){
            const totalPoints = target*556;
            out.innerHTML = `<b>Có thể đạt cấp:</b> ${target}<br><b>Tổng điểm:</b> ${totalPoints}<br><br><b>Các bước đổi:</b><br><pre class="log">${result.log.join('\n')}</pre><br><b>Còn lại:</b><br><ul><li>Đá: ${result.remaining.stone}</li><li>Gỗ: ${result.remaining.wood}</li><li>Quặng: ${result.remaining.ore}</li></ul>`;
            saveData(); sendPoint(totalPoints);
        } else {
            let miss = result.missing;
            out.innerHTML = `<b>Không đủ tài nguyên để đạt cấp ${target}</b><br><b>Còn thiếu:</b><br><ul><li>Đá: ${miss.stone}</li><li>Gỗ: ${miss.wood}</li><li>Quặng: ${miss.ore}</li></ul>`;
            saveData(); sendPoint(0);
        }
    } else {
        let res = computeMaxLv(S,W,Q,B);
        if(res.remaining){
            const totalPoints = res.maxLv*556;
            out.innerHTML = `<b>Cấp tối đa:</b> ${res.maxLv}<br><b>Tổng điểm:</b> ${totalPoints}<br><br><b>Các bước đổi:</b><br><pre class="log">${res.log.join('\n')}</pre><br><b>Còn lại:</b><br><ul><li>Đá: ${res.remaining.stone}</li><li>Gỗ: ${res.remaining.wood}</li><li>Quặng: ${res.remaining.ore}</li></ul>`;
            saveData(); sendPoint(totalPoints);
        } else {
            out.innerHTML = `<b>Không đủ tài nguyên để nâng cấp</b>`;
            saveData(); sendPoint(0);
        }
    }
}

function saveData(){
    if(!currentAcc) return;
    const data = {stone: document.getElementById('stone').value, wood: document.getElementById('wood').value, ore: document.getElementById('ore').value, boxes: document.getElementById('boxes').value, target: document.getElementById('targetLevel').value};
    try{ localStorage.setItem(keyFor(currentAcc), JSON.stringify(data)); } catch(e){}
}

function loadData(){
    if(!currentAcc) return;
    document.getElementById('curAcc').textContent = currentAcc;
    const raw = localStorage.getItem(keyFor(currentAcc));
    if(!raw) return;
    try{ const d = JSON.parse(raw); document.getElementById('stone').value = d.stone || 0; document.getElementById('wood').value = d.wood || 0; document.getElementById('ore').value = d.ore || 0; document.getElementById('boxes').value = d.boxes || 0; document.getElementById('targetLevel').value = d.target || ""; } catch(e){}
}

function sendPoint(v){
    try{ parent.postMessage({type:'updatePoint', tab:'phao', value:Number(v)||0}, "*"); } catch(e){}
}

window.addEventListener("message", e=>{
    const d = e.data || {};
    if(d && d.type === "acc_changed"){ currentAcc = d.acc || localStorage.getItem("current_acc") || ""; loadData(); const p = Number(JSON.parse(localStorage.getItem("acc_" + currentAcc + "_points") || "{}").phao) || 0; sendPoint(p); }
    if(d && d.type === "request_point"){ const p = Number(JSON.parse(localStorage.getItem("acc_" + currentAcc + "_points") || "{}").phao) || 0; sendPoint(p); }
});

window.parent.postMessage({type:'ready'}, "*");
document.getElementById('btnCompute').addEventListener('click', compute);
</script>
</body>
</html>
